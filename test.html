<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Motor Agenda</title>
</head>
<body>

<h2>Agenda con Bloqueo Real</h2>

<button onclick="generar()">Generar</button>

<pre id="resultado"></pre>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbye6IIQJwokLvNTuhr49o9xxMmwc1PbQvwLrKYqe6MJ7p0YR5pNZdWJnU4GmeLab4TLug/exec";

async function generar() {

  const [horariosRes, reservasRes] = await Promise.all([
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action: "obtenerHorarios" })
    }),
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action: "obtenerReservas" })
    })
  ]);

  const horarios = (await horariosRes.json()).horarios;
  const reservas = (await reservasRes.json()).reservas;

  const hoy = new Date();
  let agenda = [];

  for (let i = 0; i < 7; i++) {

    const fecha = new Date();
    fecha.setDate(hoy.getDate() + i);

    const nombreDia = capitalizar(
      fecha.toLocaleDateString("es-AR", { weekday: "long" })
    );

    const fechaISO = fecha.toISOString().split("T")[0];

    let bloquesDia = [];

    horarios.forEach(h => {
      if (h.dia === nombreDia) {

        let minutos = (h.tipo === "FRACCIONADO") ? 30 : 60;
        let inicio = convertirMinutos(h.inicio);
        let fin = convertirMinutos(h.fin);

        for (let t = inicio; t < fin; t += minutos) {

          const hora = convertirHora(t);

          const ocupado = reservas.some(r =>
            r.fecha === fechaISO && r.hora === hora
          );

          if (!ocupado) {
            bloquesDia.push({
              fecha: fechaISO,
              hora: hora
            });
          }
        }
      }
    });

    agenda.push({
      fecha: fechaISO,
      dia: nombreDia,
      bloquesDisponibles: bloquesDia
    });
  }

  document.getElementById("resultado").innerText =
    JSON.stringify(agenda, null, 2);
}

function convertirMinutos(hora) {
  const [h, m] = hora.split(":").map(Number);
  return h * 60 + m;
}

function convertirHora(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return String(h).padStart(2, '0') + ":" + String(m).padStart(2, '0');
}

function capitalizar(texto) {
  return texto.charAt(0).toUpperCase() + texto.slice(1);
}
</script>

</body>
</html>
