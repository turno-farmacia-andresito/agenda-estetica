<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agenda Online</title>
  <style>
    body {
      font-family: Arial;
      padding: 30px;
    }

    h1 {
      margin-bottom: 20px;
    }

    .servicios button,
    .horario-btn {
      padding: 8px 14px;
      margin: 5px;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f5f5f5;
    }

    .servicios button.activo {
      background: #72bd99;
      color: white;
      border: none;
    }

    .dia {
      margin-top: 15px;
      font-weight: bold;
      cursor: pointer;
    }

    .horarios-container {
      margin-top: 8px;
      margin-bottom: 10px;
    }

  </style>
</head>

<body>

<h1>Agenda Online</h1>

<h3>1️⃣ Elegí el servicio</h3>
<div class="servicios">
  <button onclick="seleccionarServicio(this)">Facial</button>
  <button onclick="seleccionarServicio(this)">Limpieza</button>
  <button onclick="seleccionarServicio(this)">Corporal</button>
</div>

<hr>

<h3>2️⃣ Elegí horario disponible</h3>
<button onclick="cargarAgenda()">Ver Horarios Disponibles</button>

<div id="agenda"></div>

<script>

let servicioSeleccionado = null;
let agendaGlobal = [];

function seleccionarServicio(btn) {
  document.querySelectorAll(".servicios button").forEach(b => b.classList.remove("activo"));
  btn.classList.add("activo");
  servicioSeleccionado = btn.innerText;
}

function cargarAgenda() {

  fetch("https://script.google.com/macros/s/AKfycbyec_jJOE9A7v-zdjJ6z2Wuqt19_dqmGSrLxa0h-64vZk2K_xlZju6QQ40RtB3AEW4u/exec?action=generarAgenda")
    .then(res => res.json())
    .then(data => {

      agendaGlobal = data;
      const contenedor = document.getElementById("agenda");
      contenedor.innerHTML = "";

      data.forEach((diaData, index) => {

        const diaDiv = document.createElement("div");
        diaDiv.className = "dia";
        diaDiv.innerText = `${diaData.fecha} (${diaData.bloquesDisponibles.length})`;
        diaDiv.onclick = () => toggleHorarios(index);

        const horariosDiv = document.createElement("div");
        horariosDiv.className = "horarios-container";
        horariosDiv.id = "horarios-" + index;
        horariosDiv.style.display = "none";

        contenedor.appendChild(diaDiv);
        contenedor.appendChild(horariosDiv);

      });

    });
}

function toggleHorarios(index) {

  const horariosDiv = document.getElementById("horarios-" + index);
  const diaData = agendaGlobal[index];

  if (horariosDiv.style.display === "none") {

    horariosDiv.innerHTML = "";

    diaData.bloquesDisponibles.forEach(bloque => {

      const btn = document.createElement("button");
      btn.className = "horario-btn";
      btn.innerText = bloque.hora;

      btn.onclick = () => reservar(bloque.fecha, bloque.hora);

      horariosDiv.appendChild(btn);

    });

    horariosDiv.style.display = "block";

  } else {
    horariosDiv.style.display = "none";
  }
}

function reservar(fecha, hora) {

  if (!servicioSeleccionado) {
    alert("Primero elegí el servicio");
    return;
  }

  fetch(`https://script.google.com/macros/s/AKfycbyec_jJOE9A7v-zdjJ6z2Wuqt19_dqmGSrLxa0h-64vZk2K_xlZju6QQ40RtB3AEW4u/exec?action=reservar&fecha=${fecha}&hora=${hora}&servicio=${servicioSeleccionado}`)
    .then(res => res.json())
    .then(resp => {

      if (resp.success) {
        alert("Reserva confirmada");
        cargarAgenda();
      } else {
        alert("Error al reservar");
      }

    });

}

</script>

</body>
</html>
